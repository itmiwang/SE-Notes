# 认识分层架构及如何提升系统性能

------

## 本节概述

- 了解什么是分层架构以及分层架构的优势和不足
- 了解如何提升系统性能

## 主要内容

### 高并发系统通用设计方法

##### 分层设计的好处

- 分层的设计可以简化系统设计，让不同的人专注做某一层次的事情。

- 分层之后可以做到很高的复用

    将具有通用性的部分抽离，减少研发周期，提升研发效率。

- 分层架构可以更容易做横向扩展

    如果没有系统分层，当流量增加时，我们需要对整体系统来做扩展。但是，如果将系统分层后，就可以针对具体的问题来做细致的扩展，这相比于整体系统扩展所付出的代价要小得多。

##### 分层设计的不足

- 增加了代码的复杂度（开发、调试）
- 多层架构会带来性能上的损耗

##### 如何做系统分层

- 考虑分层后每个层次的边界
- 考虑层次之间一定是相邻层互相依赖，数据的流转也只能在相邻的两层之间流转。



### 如何提升系统性能

高并发，是指运用技术手段让系统能够处理更多的用户并发请求，也就是承担更大的流量。它是一切架构设计的背景和前提，脱离它谈性能和可用性是没有意义的。

高并发系统设计的三大目标：高性能、高可用、可扩展

- 高性能

    性能反映了系统的使用体验

- 高可用

    可用性表示系统可以正常服务用户的时间

- 可扩展

    易于扩展的系统能在短时间内迅速完成扩容，更加平稳地承担峰值流量。

##### 性能优化原则

1. 性能优化一定不能盲目，一定是问题导向的。
2. 性能优化也遵循“二八原则”，即使用20%的精力解决80%的性能问题。所以优化过程要集中主要矛盾和性能瓶颈点。
3. 性能优化要有数据支撑。一边优化，一边观察响应时间减少了多少、吞吐量提升了多少。
4. 性能优化的过程是持续的。需要我们持续不断地寻找性能瓶颈，制定优化方案，直到达到优化目标为止。

##### 性能的度量指标

收集某段时间内系统接口的响应时间，并依据统计方法计算出特征值，这些特征值就能够代表这段时间的性能情况。

- 平均值

    平均值是把这段时间所有请求的响应时间数据相加，再除以总请求数。平均值可以在一定程度上反应这段时间的性能，但它敏感度比较差，如果这段时间有少量慢请求时，在平均值上并不能如实地反应。

- 最大值

    最大值就是这段时间内所有请求响应时间最长的值，但它的问题又在于过于敏感了。

- 分位值

    分位值有很多种，比如 90 分位、95 分位、75 分位。分位值排除了偶发极慢请求对于数据的影响，能够很好的反映这段时间的性能情况，分位值越大，对于满请求的影响就越敏感。

    以 90 分位为例，我们把这段时间请求的响应时间从小到大排序，假如一共有 100 个请求，那么排在第 90 位的响应时间就是 90 分位值。

    分位值是最适合作为时间段内，响应时间统计值来使用的。

##### 吞吐量和响应时间

这两者是成倒数关系的。比如，响应时间 1s 时，吞吐量是每秒 1 次，响应时间缩短到 10ms，那么吞吐量就上升到每秒 100 次。所以，一般我们度量性能时都会同时兼顾吞吐量和响应时间。比如，在每秒 1 万次的请求量下，响应时间 99 分位值在 10ms 以下。

响应时间控制的范围，有以下几个分界点：

- < 200ms，用户感觉不到延迟
- < 1s，用户会感受到延迟，但是可以接受
- 超过 1s，会有明显等待的感觉。

所以，健康系统的99分位值的响应时间通常需要控制在200ms内，而不超过1s的请求占比要在99.99%以上。

##### 高并发下的性能优化

1. 提高系统的处理核心数

    提高系统的处理核心数就是增加系统的并行处理能力，

    吞吐量 = 并发进程数 / 响应时间

    但是，随着并发进程数的增加，并行的任务对于系统资源的争抢也会愈发严重。在某一个临界点上继续增加并发进程数，反而会造成系统性能的下降，这就是性能测试中的拐点模型。

    <img src="picture/03.%E8%AE%A4%E8%AF%86%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84%E5%8F%8A%E5%A6%82%E4%BD%95%E6%8F%90%E5%8D%87%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD/image-20210427171306491.png" alt="image-20210427171306491" style="zoom:23%;" />

    从图中你可以发现，并发用户数处于轻压力区时，响应时间平稳，吞吐量和并发用户数线性相关。而当并发用户数处于重压力区时，系统资源利用率到达极限，吞吐量开始有下降的趋势，响应时间也会略有上升。这个时候，再对系统增加压力，系统就进入拐点区，处于超负荷状态，吞吐量下降，响应时间大幅度上升。

    所以我们在评估系统性能时通常需要做压力测试，目的就是找到系统的“拐点”，从而知道系统的承载能力，也便于找到系统的瓶颈，持续优化系统性能。

2. 减少单次任务响应时间

    首先，确认系统是CPU密集型还是IO密集型。因为不同类型的系统优化方式不同。

    - CPU密集型（指存在大量计算）

        选用更高效的算法或者减少运算次数

        发现这类问题的主要方式，是通过一些 Profile 工具来找到消耗 CPU 时间最多的方法或者模块，比如 Linux 的 perf、eBPF 等。

    - IO密集型（IO 指的是磁盘 IO 和网络 IO）

        我们熟知的系统大部分都属于 IO 密集型，比如数据库系统、缓存系统、Web 系统。这类系统的性能瓶颈可能出在系统内部，也可能是依赖的其他系统。

        发现这类问题的主要方式：

        - 采用工具

            比如说 Java 语言就有其专属的内存分析工具

        - 通过监控

            在监控中我们可以对任务的每一个步骤做分时的统计，从而找到任务的哪一步消耗了更多的时间



## 本节总结

1. 任何的方案架构都是有优势有缺陷的，天地尚且不全何况我们的架构呢？分层架构固然会增加系统复杂度，也可能会有性能的损耗，但是相比于它能带给我们的好处来说，这些都是可以接受的，或者可以通过其它的方案解决的。我们在做决策的时候切不可以偏概全，因噎废食。
2. 关于性能优化
    - 数据优先，你做一个新的系统在上线之前一定要把性能监控系统做好；
    - 掌握一些性能优化工具和方法，这就需要在工作中不断地积累；
    - 计算机基础知识很重要，比如说网络知识、操作系统知识等等，掌握了基础知识才能让你在优化过程中抓住性能问题的关键，也能在性能优化过程中游刃有余。

## 知识拓展

### 相关文章推荐

### 知识点拓展



